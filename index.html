<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Entregas</title>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseUrl = 'https://quizexqrmwugokprnnwf.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1aXpleHFybXd1Z29rcHJubndmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MzA2NTMsImV4cCI6MjA4NzIwNjY1M30.RLxguaWi-BBAEdzqO0L0uw0lV5FscDrv9m-lTxl5siU';
const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
</script>

<style>
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;background:#f4f6f8}
header{background:#1e88e5;color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center;font-weight:bold;position:sticky;top:0}
.container{padding:12px;max-width:900px;margin:auto}
.card{background:#fff;border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);border-left:6px solid #ccc}
.card.entregue{border-left-color:#43a047;background:#e8f5e9}
.card.nao_entregue{border-left-color:#e53935;background:#fdecea}
.card.pendente{border-left-color:#9e9e9e;background:#f5f5f5}
.row{display:flex;gap:8px;flex-wrap:wrap}
input,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px}
button{background:#1e88e5;color:#fff;border:none;font-weight:bold;cursor:pointer}
button.done{background:#43a047}
button.nao{background:#e53935}
button.del{background:#b71c1c}
.status{margin-top:8px;font-size:14px}
#loginArea{min-height:100vh;display:flex;align-items:center;justify-content:center}
.login-card{background:#fff;padding:20px;border-radius:14px;max-width:360px;width:100%;box-shadow:0 6px 16px rgba(0,0,0,.15)}
@media print{
body *{visibility:hidden}
#printArea,#printArea *{visibility:visible}
#printArea{position:absolute;left:0;top:0;width:100%}
#printArea table{width:100%;border-collapse:collapse}
#printArea th,#printArea td{border:1px solid #000;padding:6px}
#printArea th{background:#eee}
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginArea">
  <div class="login-card">
    <h2>üîê Entrar</h2>
    <input id="loginUser" placeholder="Usu√°rio">
    <br><br>
    <input id="loginPass" type="password" placeholder="Senha">
    <br><br>
    <button onclick="login()">Entrar</button>
    <p id="loginErro" style="color:red;display:none">Usu√°rio ou senha inv√°lidos</p>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
<header>
  <span>üì¨ Controle de Entregas</span>
  <small id="datetime"></small>
  <button onclick="logout()">Sair</button>
</header>

<div class="container">

  <div class="card">
    <h3>‚ûï Adicionar entrega</h3>
    <input id="condominioInput" placeholder="Condom√≠nio">
    <div class="row">
      <input id="predioInput" placeholder="Bloco">
      <input id="portaInput" placeholder="Apartamento">
    </div>
    <button onclick="adicionar()">Adicionar</button>
  </div>

  <div class="card">
    <h3>üîç Filtros</h3>
    <select id="filtroCondominio" onchange="render()"></select>
    <select id="filtroBloco" onchange="render()"></select>
    <div id="contador" class="status"></div>
  </div>

  <div class="card">
    <h3>üñ®Ô∏è Imprimir</h3>
    <button onclick="imprimir()">Imprimir por bloco</button>
  </div>

  <div id="lista"></div>
</div>
</div>

<div id="printArea"></div>

<script>
const usuarios = [
  {user:'Thiago', pass:'123'},
  {user:'Fabio', pass:'123'}
];
let entregas = [];

// Login/Logout
function login() {
  if (!usuarios.find(u=>u.user===loginUser.value && u.pass===loginPass.value)) {
    loginErro.style.display='block';
    return;
  }
  localStorage.setItem('usuarioLogado', loginUser.value);
  iniciar();
}
function logout() {
  localStorage.removeItem('usuarioLogado');
  location.reload();
}

// Inicializa√ß√£o
async function iniciar() {
  loginArea.style.display='none';
  app.style.display='block';
  await popularCondominio(); // popula apenas se ainda n√£o existe
  await carregar();
  atualizarHora();
}

// Popula o condom√≠nio apenas uma vez
async function popularCondominio() {
  const condominio = 'Pra√ßa das Am√©ricas';
  const blocos = [1,2,3];
  const totalApartamentos = 176;

  // Checa se j√° existe no banco
  const { data: existentes } = await supabaseClient.from('entregas').select('*').eq('condominio', condominio).limit(1);
  if (existentes.length > 0) return; // j√° populado

  const registros = [];
  blocos.forEach(bloco => {
    for (let i=1;i<=totalApartamentos;i++){
      const apto = String(i).padStart(3,'0');
      registros.push({ condominio, predio: `Bloco ${bloco}`, porta: apto, status: 'pendente' });
    }
  });
  await supabaseClient.from('entregas').insert(registros);
  console.log('Condom√≠nio populado automaticamente!');
}

// Carregar entregas
async function carregar() {
  const { data } = await supabaseClient.from('entregas').select('*').order('predio',{ascending:true}).order('porta',{ascending:true});
  entregas = data || [];
  render();
}

// Adicionar entrega manual
async function adicionar() {
  if(!condominioInput.value || !predioInput.value || !portaInput.value) return;
  await supabaseClient.from('entregas').insert({
    condominio: condominioInput.value,
    predio: predioInput.value,
    porta: portaInput.value,
    status: 'pendente'
  });
  condominioInput.value = predioInput.value = portaInput.value = '';
  carregar();
}

// Marcar e deletar
async function marcar(id,status){
  await supabaseClient.from('entregas').update({status}).eq('id',id);
  carregar();
}
async function deletar(id){
  if(!confirm('Deletar entrega?')) return;
  await supabaseClient.from('entregas').delete().eq('id',id);
  carregar();
}

// Renderizar lista e filtros
function render(){
  lista.innerHTML='';

  const fc = filtroCondominio.value;
  const fb = filtroBloco.value;

  const condominios = [...new Set(entregas.map(e=>e.condominio))];
  filtroCondominio.innerHTML = '<option value="">Todos</option>';
  condominios.forEach(c=>filtroCondominio.innerHTML+=`<option>${c}</option>`);
  filtroCondominio.value = fc;

  const blocos = [...new Set(entregas.map(e=>e.predio))];
  filtroBloco.innerHTML = '<option value="">Todos</option>';
  blocos.forEach(b=>filtroBloco.innerHTML+=`<option>${b}</option>`);
  filtroBloco.value = fb;

  let list = entregas;
  if(fc) list = list.filter(e=>e.condominio===fc);
  if(fb) list = list.filter(e=>e.predio===fb);

  contador.innerText = `Total: ${list.length}`;

  list.forEach(e=>{
    const d=document.createElement('div');
    d.className='card '+e.status;
    d.innerHTML=`
      <h3>${e.condominio} ‚Äî ${e.predio}</h3>
      <div>üö™ Apto ${e.porta}</div>
      <div class="row">
        <button class="done">Entregue</button>
        <button class="nao">N√£o</button>
        <button class="del">Del</button>
      </div>
      <div class="status">${e.status}</div>
    `;
    d.querySelector('.done').onclick=()=>marcar(e.id,'entregue');
    d.querySelector('.nao').onclick=()=>marcar(e.id,'nao_entregue');
    d.querySelector('.del').onclick=()=>deletar(e.id);
    lista.appendChild(d);
  });
}

// Imprimir
function imprimir(){
  const fc=filtroCondominio.value;
  const fb=filtroBloco.value;
  if(!fc || !fb) return alert('Selecione condom√≠nio e bloco');
  const list=entregas.filter(e=>e.condominio===fc && e.predio===fb);
  let html=`<h2>${fc} ‚Äî ${fb}</h2>
    <table><tr><th>Apto</th><th>Status</th><th>Assinatura</th></tr>`;
  list.forEach(e=>html+=`<tr><td>${e.porta}</td><td>${e.status}</td><td></td></tr>`);
  html+='</table>';
  printArea.innerHTML=html;
  window.print();
}

// Atualizar hora
function atualizarHora(){
  const d=new Date();
  datetime.innerText=d.toLocaleDateString('pt-BR')+' '+d.toLocaleTimeString('pt-BR');
}
setInterval(atualizarHora,1000);

// Inicializa√ß√£o autom√°tica
if(localStorage.getItem('usuarioLogado')) iniciar();
</script>

</body>
</html>
